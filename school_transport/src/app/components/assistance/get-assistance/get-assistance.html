<div class="card">
  <h2 class="text-2xl font-bold mb-4 text-gray-700">Asistencias</h2>

  <div class="flex justify-end mb-4">
    <p-button label="Formulario" severity="success" [routerLink]="['/assistance/add']">
    </p-button>
  </div>

  <!-- Filtros -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
    <!-- Ruta -->
    <div>
      <label class="block text-sm font-semibold mb-1">Ruta</label>
      <select [(ngModel)]="selectedRouteId" name="route" class="w-full border rounded px-3 py-2" (change)="onRouteChange()">
        <option [ngValue]="undefined">Todas</option>
        <option *ngFor="let r of routes" [ngValue]="r.id">{{ r.name }} — #{{ r.id }}</option>
      </select>
    </div>

    <!-- Bus (depende de ruta) -->
    <div>
      <label class="block text-sm font-semibold mb-1">Bus</label>
      <select [(ngModel)]="selectedBusId" name="bus" class="w-full border rounded px-3 py-2" (change)="onBusChange()"
              [disabled]="!selectedRouteId">
        <option [ngValue]="undefined">Todos</option>
        <option *ngFor="let b of filteredBuses" [ngValue]="b.id">{{ b.plate }} — #{{ b.id }}</option>
      </select>
      <p class="text-xs text-gray-500 mt-1" *ngIf="selectedRouteId && !filteredBuses.length">
        Esta ruta no tiene buses asignados.
      </p>
    </div>

    <!-- Fecha -->
    <div>
      <label class="block text-sm font-semibold mb-1">Fecha</label>
      <input type="date" class="w-full border rounded px-3 py-2" [value]="selectedDate || null" (change)="onDateChange($event)" />
    </div>
  </div>

  <!-- Tabla -->
  <p-table [value]="rows" [tableStyle]="{ 'min-width': '64rem' }" responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th>Estudiante</th>
        <th>Ruta</th>
        <th>Bus</th>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Estado</th>
        <th class="text-center">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-r>
      <tr>
        <td>#{{ r.studentId }} — {{ r.studentName }}</td>
        <td>#{{ r.routeId }} — {{ r.routeName }}</td>
        <td>#{{ r.busId }} — {{ r.busPlate }}</td>
        <td>{{ r.date | date:'yyyy-MM-dd' }}</td>
        <td>{{ r.time }}</td>
        <td>
          <p-tag [value]="r.status" [severity]="statusSeverity(r.status)"></p-tag>
        </td>
        <td class="flex gap-2 ">
        <button pButton icon="pi pi-pencil"    severity="secondary"  class="p-1" [routerLink]="['/assistance/edit', r.id]"></button>
          <button pButton icon="pi pi-check"  severity="success"  class="p-1" (click)="setStatus(r, 'CONFIRMADO')"></button>
          <button pButton icon="pi pi-times"  severity="danger"   class="p-1" (click)="setStatus(r, 'AUSENTE')"></button>
          <button pButton icon="pi pi-ban"    severity="warn"  class="p-1" (click)="setStatus(r, 'CANCELADO')"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
