<div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow">
  <ng-container *ngIf="!loading; else loadingTpl">
    <h2 class="text-xl font-bold mb-6">Editar Asistencia #{{ form?.id }}</h2>
    <p *ngIf="error" class="mb-4 text-sm text-red-600">{{ error }}</p>

    <form *ngIf="form" (ngSubmit)="save()" class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Ruta -->
    <div>
      <label class="block font-semibold mb-1">Ruta *</label>
      <select [(ngModel)]="form.routeId" name="routeId" class="w-full border rounded px-3 py-2" required (change)="onRouteChange()">
        <option [ngValue]="undefined">Seleccione una ruta</option>
        <option *ngFor="let r of routes" [ngValue]="r.id">{{ r.name }} — #{{ r.id }}</option>
      </select>
    </div>

    <!-- Bus (depende de ruta) -->
    <div>
      <label class="block font-semibold mb-1">Bus *</label>
      <select [(ngModel)]="form.busId" name="busId" class="w-full border rounded px-3 py-2" required [disabled]="!form.routeId">
        <option [ngValue]="undefined">Seleccione un bus</option>
        <option *ngFor="let b of filteredBuses" [ngValue]="b.id">{{ b.plate }} — #{{ b.id }}</option>
      </select>
      <p *ngIf="form.routeId && !filteredBuses.length" class="text-xs text-amber-700 mt-1">
        Esta ruta no tiene buses asignados.
      </p>
    </div>

    <!-- Estudiante -->
    <div class="md:col-span-2">
      <label class="block font-semibold mb-1">Estudiante *</label>
      <select [(ngModel)]="form.studentId" name="studentId" class="w-full border rounded px-3 py-2" required>
        <option [ngValue]="undefined">Seleccione un estudiante</option>
        <option *ngFor="let s of students" [ngValue]="s.id">
          #{{ s.id }} — {{ s.name }} {{ s.lastName || '' }}
        </option>
      </select>
    </div>

    <!-- Fecha -->
    <div>
      <label class="block font-semibold mb-1">Fecha *</label>
      <input type="date" class="w-full border rounded px-3 py-2" [value]="dateInput" (change)="onDateChange($event)" required />
    </div>

    <!-- Hora -->
    <div>
      <label class="block font-semibold mb-1">Hora *</label>
      <input type="time" class="w-full border rounded px-3 py-2" [value]="timeInput" (change)="onTimeChange($event)" required />
    </div>

    <!-- Estado -->
      <div class="md:col-span-2">
        <label class="block font-semibold mb-1">Estado</label>
        <select [(ngModel)]="form.status" name="status" class="w-full border rounded px-3 py-2">
          <option value="ACTIVO">ACTIVO</option>
          <option value="INACTIVO">INACTIVO</option>
        </select>
      </div>

      <!-- Acciones -->
      <div class="md:col-span-2 flex justify-end gap-2 mt-2">
        <button pButton type="button" label="Cancelar" class="!bg-gray-500 !border-none" (click)="cancel()"></button>
        <button
          pButton
          type="submit"
          [label]="saving ? 'Guardando...' : 'Guardar'"
          icon="pi pi-save"
          severity="primary"
          [disabled]="saving">
        </button>
      </div>
    </form>
  </ng-container>

  <ng-template #loadingTpl>
    <p class="text-center text-gray-600">Cargando asistencia...</p>
  </ng-template>
</div>
